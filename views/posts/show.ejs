<% layout('layouts/post-show-layout') -%>
<h1><%= post.title %></h1>
<p>Price: $<%= post.price %></p>
<% for (let img of post.images) { %>
    <img src="<%=img.path%>" alt="post image" style="height:200px"> 
<% } %> 
<div id='map' style='width: 400px; height: 300px;'></div>
<p>Description: <%= post.description %></p>
<p>Location: <%= post.location %></p>
<p>Community rating: 
    <% for (let i = 0; i < 5; ++i) { %>
        <% if (i < floorRating) { %>
            <i class="fas fa-star"></i>
        <% } else if ((post.avgRating - i) > 0 && (post.avgRating - i) < 1) { %>
            <i class="fas fa-star-half-alt"></i>
        <% } else { %>
            <i class="far fa-star"></i>
        <% } %>
    <% } %> 
</p>
<% if (currentUser && post.author.equals(currentUser._id)) { %> 
<div>
    <a href="/posts/<%=post._id%>/edit"><button>Edit</button></a>
    <form action="/posts/<%=post._id%>?_method=DELETE" method="POST">
        <button>Delete</button>
    </form>
</div>
<% } %> 
<p>Author: <%= post.author.username %>  </p>
<% if (currentUser) { %> 
<h2>Create a review</h2>
<form action="/posts/<%=post._id%>/reviews" method="POST">
    <label for="body">Review</label><br>
    <textarea name="review[body]" id="body" cols="30" rows="5" required></textarea><br>
    <fieldset class="starability-basic">
        <legend>Rating:</legend>
        <input type="radio" id="rate0" class="input-no-rate" name="review[rating]" value="0" checked aria-label="No rating." />
        <input type="radio" id="rate1" name="review[rating]" value="1" />
        <label for="rate1" title="Terrible">1 star</label>
        <input type="radio" id="rate2" name="review[rating]" value="2" />
        <label for="rate2" title="Not good">2 stars</label>
        <input type="radio" id="rate3" name="review[rating]" value="3" />
        <label for="rate3" title="Average">3 stars</label>
        <input type="radio" id="rate4" name="review[rating]" value="4" />
        <label for="rate4" title="Very good">4 stars</label>
        <input type="radio" id="rate5" name="review[rating]" value="5" />
        <label for="rate5" title="Amazing">5 stars</label>
    </fieldset>
    <button>Submit</button>
</form>
<% } else { %>
    <h2><a href="/login?returnTo=true">Create a review</a></h2>
<% } %> 
<h3>Reviews</h3>
<% for (let review of post.reviews) { %>
    <div>
        <div>
            <p>Author: <%= review.author.username %></p>
            <p class="starability-result" data-rating="<%= review.rating %>">
                Rated: <%= review.rating %> stars
              </p>
            <p><%= review.body %></p>
        </div>
        <% if (currentUser && review.author.equals(currentUser._id)) { %> 
        <div>
            <button class="toggle-edit-form">Edit</button>
            <form action="/posts/<%=post._id%>/reviews/<%=review._id%>?_method=DELETE" method="POST">
                <button>Delete</button>
            </form>
            <form action="/posts/<%=post._id%>/reviews/<%=review._id%>?_method=PUT" method="POST" class="edit-review-form">
                <label for="body">Review</label><br>
                <textarea name="review[body]" id="body" cols="30" rows="5" required><%= review.body  %></textarea><br>
                <fieldset class="starability-basic">
                    <legend>Rating:</legend>
                    <input type="radio" id="edit-rate0" class="input-no-rate" name="review[rating]" value="0" checked aria-label="No rating." />
                    <input type="radio" id="edit-rate1" name="review[rating]" value="1" />
                    <label for="edit-rate1" title="Terrible">1 star</label>
                    <input type="radio" id="edit-rate2" name="review[rating]" value="2" />
                    <label for="edit-rate2" title="Not good">2 stars</label>
                    <input type="radio" id="edit-rate3" name="review[rating]" value="3" />
                    <label for="edit-rate3" title="Average">3 stars</label>
                    <input type="radio" id="edit-rate4" name="review[rating]" value="4" />
                    <label for="edit-rate4" title="Very good">4 stars</label>
                    <input type="radio" id="edit-rate5" name="review[rating]" value="5" />
                    <label for="edit-rate5" title="Amazing">5 stars</label>
                </fieldset>
                <button>Update</button>
            </form>

            <script>
                $('#edit-rate<%=review.rating%>').prop('checked', true);
            </script>
        </div>
        <% } %> 
    </div>
    <hr>
<% } %>